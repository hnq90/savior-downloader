!function(){function a(a){var b=a.url,a="object"==typeof b?b.videoUrl+"\n"+b.audioUrl:b,c=h.hash(a);return c.toString()}function b(a,c){var d=c[0],e={};if(!d){if(a.length>1)for(var f=0;f<a.length;++f){var g=a[f],j=g.url();if("object"==typeof j&&(j=j.videoUrl),-1!==j.indexOf(".googlevideo.com"))return[g]}return[a[0]]}return a.forEach(function(a){var b=a[d]&&a[d]()||"";e[b]=e[b]||[],e[b].push(a)}),Object.keys(e).map(function(a){var f=b(e[a],c.slice(1)),g={media:f};return g[d]=h.defined(a)?a:void 0,g.is_only=1===f.length&&(!h.defined(f[0].is_only)||f[0].is_only),g["i18n_"+d]=i("media_fields_"+d+"_"+a),g})}function c(a){return a.forEach(function(a){var b=a.type;a.media.forEach(function(a){a.media=a.media.sort(function(a,c){return g[b].extensions.indexOf(a.ext)-g[b].extensions.indexOf(c.ext)})})}),a}function d(a){return a.ext?(a.media=a.media.sort(function(a,b){return quality.getQualityLevelByType(a.quality)-quality.getQualityLevelByType(b.quality)}),a):(Array.isArray(a)?a=a.map(d):a.media=d(a.media),a)}function e(a){return d(c(a))}function f(){r.done(function(a){chrome.tabs.connect(a,{name:"overlay"})})}{const g={audio:{title:"Audio",contentTypes:[/audio/i],extensions:["mp3","flac","m4a","wma","ogg","wav","aif","mid"],ctype2extension:{midi:"mid",mp4:"m4a",m4a:"m4a",mpeg:"mp3",mpeg3:"mp3",wav:"wav",aiff:"aif"}},video:{title:"Video",contentTypes:[/video/i],extensions:["mp4","mpeg4","mpg","mpeg","m4v","avi","divx","mov","wmv","movie","asf","webm","flv","3gp"],ctype2extension:{mpeg:"mp4",mp4:"mp4",m4v:"mp4","3gpp":"3gp",flv:"flv",quicktime:"mov",msvideo:"avi","ms-wmv":"wmv","ms-asf":"asf"}}};!function(){var a={};return Object.keys(g).forEach(function(b){for(var c=g[b].extensions,d=0;d<c.length;d++)a[c[d]]=b}),a}()}var h={EXTENSION_RE:/\.([^/.]*)$/i,FILENAME_RE:/([^/]+)$/i,SIZES:["","K","M","G","T","P"],xmlParser:new DOMParser,urlParser:document.createElement("a"),fileDownloader:document.createElement("a"),strip:function(a){return a.replace(/(^\s+)|(\s+$)/m,"")},endsWith:function(a,b){var c=a.length-b.length;return a.indexOf(b,c)===c},hash:function(a,b){if(b=0|b,0===a.length)return b;var c,d;for(c=0,d=a.length;d>c;c++)b=(b<<5)-b+a.charCodeAt(c),b|=0;return b},query:function(a,b){return b=b||document,b.querySelector(a)},queryAll:function(a,b){return b=b||document,h.toArray(b.querySelectorAll(a))},findParent:function(a,b){for(;null!==a&&!a.classList.contains(b);)a=a.parentNode;return a},toArray:function(a){return Array.prototype.slice.call(a)},unique:function(a){var b=[];return Array.isArray(a)?(a.forEach(function(a){-1===b.indexOf(a)&&b.push(a)}),b):a},extend:function(a,b){var c=function(){};c.prototype=a.prototype,b.prototype=new c,b.prototype.constructor=b,b._super=a.prototype},parseUrl:function(a){var b=h.urlParser;b.setAttribute("href",a);var c=(b.pathname.match(h.FILENAME_RE)||[])[1]||"",d=c.split(".").map(function(a){return a.toLowerCase()});c=decodeURIComponent(c.replace(h.EXTENSION_RE,"")),d.shift();var e=d[d.length-1]||"";return{url:a,protocol:b.protocol,host:b.host,port:b.port,pathname:b.pathname,filename:c,ext:e,exts:d,search:b.search}},isMatches:function(a,b){var c,d,e;if(Array.isArray(a)){for(c=0;c<a.length;++c)if(h.isMatches(a[c],b))return!0;return!1}for(b=Array.isArray(b)?b:[b],c=0,d=b.length,e;d>c;++c)if(e=b[c],"string"==typeof e&&-1!==a.indexOf(e)||e instanceof RegExp&&a.match(e))return!0;return!1},_sendBackgroundRequest:function(a,b,c,d){var e=new k;return chrome.runtime.sendMessage({requestType:"make_http_request",method:a,url:b,params:c,headers:d},function(a){e[a.success?"resolve":"reject"](a.data)}),e},send:function(a,b,c,d){var e=new k,f=null;if(h.IS_CONTENT_SCRIPT)return h._sendBackgroundRequest(a,b,c,d);try{var g=new XMLHttpRequest;if(g.open(a,b,!0),g.setRequestHeader("Cache-Control","no-cache"),"object"==typeof c&&(f=Object.keys(c).map(function(a){return a+"="+c[a]}).join("&")),"object"==typeof d)for(var i in d)g.setRequestHeader(i,d[i]);"POST"===a&&g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g.onload=function(){e.resolve(this.responseText)},g.onerror=function(){e.reject()},g.send(f)}catch(j){e.reject()}return e},get:function(a,b){return h.send("GET",a,{},b)},post:function(a,b,c){return h.send("POST",a,b,c)},_getSize:function(a){function b(a){d&&d[a?"resolve":"reject"](a),d=null,c.abort(),clearTimeout(e),e=null}var c=new XMLHttpRequest,d=new k,e=null,f=1e4;return c.open("GET",a),c.setRequestHeader("Cache-Control","no-cache"),c.url=a,c.onreadystatechange=function(){if(!(this.readyState<2)){var a=null;try{a=+this.getResponseHeader("Content-Length")}catch(c){}(null!==a||200===this.status)&&(200!==this.status&&(a=null),b(a))}},c.send(null),e=setTimeout(b,f),d},getSize:function(a){var b=new k,c=window.cache;return c.get(a).success(function(d){d?(b.resolve(d),c.put(a,d)):b.bind(h._getSize(a)).success(c.put.bind(c,a))}).fail(function(){b.bind(h._getSize(a)).success(c.put.bind(c,a))}),b},beautifyFileSize:function(a){if(null===a||"undefined"==typeof a)return"???";for(var b=0;b<h.SIZES.length&&a>=1024;++b,a/=1024);return Math.round(10*a)/10+h.SIZES[b]+"b"},detectMediaTypeAndExt:function(a,b){b=b||"","string"==typeof a&&(a=h.parseUrl(a));var c=h.getMediaType(b,a.exts);return c&&g[c]&&(a.type=c,a.ext=this._findIntersection(a.exts,g[c].extensions)||h.extByContentType(b,c)||a.ext),a},getMediaType:function(a,b){var c;for(var d in g){c=g[d];for(var e=0;e<c.contentTypes.length;++e)if(a.match(c.contentTypes[e]))return d;if(Array.isArray(b)&&h._findIntersection(b,c.extensions)||-1!==c.extensions.indexOf(b))return d}return null},_findIntersection:function(a,b){for(var c=a.concat(b),d={},e=0;e<c.length;++e){var f=c[e];if(d[f])return f;d[f]=!0}return null},extByContentType:function(a,b){var c=g[b].ctype2extension;for(var d in c)if(-1!==a.indexOf(d))return c[d];return null},isTrue:function(a){return!!a},noop:function(){},defined:function(a){return"undefined"!=typeof a},notNull:function(a){return null!==a}},i=chrome.i18n.getMessage;try{chrome.extension.getBackgroundPage(),h.IS_CONTENT_SCRIPT=!1}catch(j){h.IS_CONTENT_SCRIPT=!0}var k=function(a){if(0===arguments.length)return this._init(),this;if(a instanceof k)return a;var b=new k;return b.resolve(a),b};k.RUNNING=0,k.RESOLVED=1,k.FAILED=2,k.prototype={constructor:k,_init:function(){this._results=[],this._subscribers=[],this.state=k.RUNNING},_notify:function(){var a=this;this._subscribers.forEach(function(b){b.apply(a,a._results)}),this._subscribers=[]},resolve:function(){return this.state=k.RESOLVED,this._results=arguments,this._notify(),this},reject:function(){return this.state=k.FAILED,this._results=arguments,this._notify(),this},subscribe:function(a){this.state!==k.RUNNING?a.apply(this,this._results):this._subscribers.push(a)},done:function(a){return this.subscribe(a),this},success:function(a){var b=this;return this.subscribe(function(){b.state===k.RESOLVED&&a.apply(b,b._results)}),this},fail:function(a){var b=this;return this.subscribe(function(){b.state===k.FAILED&&a.apply(b,b._results)}),this},bind:function(a){return a=new k(a),a.success(this.resolve.bind(this)).fail(this.reject.bind(this)),this}},k.when=function(){var a=[];return a=Array.isArray(arguments[0])?arguments[0]:h.toArray(arguments),new k.When(a)},k.When=function(a){this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[],this._state=k.RUNNING,this._thingsToDo=a.length,this._results=Array(this._thingsToDo),this._init(a)},k.When.prototype={constructor:k.When,_init:function(a){var b=this;a.forEach(function(a,c){a=new k(a),a.subscribe(function(){a.state===k.FAILED&&(b._state=k.FAILED),b._results[c]=h.toArray(arguments),b._thingsToDo--,b._checkIsDone()})}),this._checkIsDone()},_checkIsDone:function(){if(0!==this._thingsToDo)return!1;var a=[];this._results.forEach(function(b){a=a.concat(b)}),this._state===k.FAILED?this._runCallbacks(this._failCallbacks,a):this._runCallbacks(this._successCallbacks,a),this._runCallbacks(this._doneCallbacks,a),this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[]},_runCallbacks:function(a,b){a.forEach(function(a){a.apply(this,b)})},done:function(a){return this._doneCallbacks.push(a),this._checkIsDone(),this},success:function(a){return this._successCallbacks.push(a),this._checkIsDone(),this},fail:function(a){return this._failCallbacks.push(a),this._checkIsDone(),this}},k.chain=function(){function a(b){if(!b.length)return c.resolve.apply(c,d);var e,f=b.shift();"function"==typeof f?(e=k(f()),e.done(function(c){d.push(c),a(b)})):(d.push(f),a(b))}var b,c=new k,d=[];return b=Array.isArray(arguments[0])?arguments[0]:h.toArray(arguments),a(b),c};var l=function(){};l.QL_HIGH="High",l.QL_MEDIUM="Medium",l.QL_LOW="Low",l.QL_VIDEO_ULTRAHD="Ultra HD",l.QL_VIDEO_FULLHD="Full HD",l.QL_VIDEO_HD="HD",l.QL_VIDEO_STANDARD="Standard",l.QL_VIDEO_MEDIUM="Medium",l.QL_VIDEO_SMALL="Small",l.QL_VIDEO_MOBILE="Mobile";var m={};m[l.QL_VIDEO_ULTRAHD]={quality:l.QL_HIGH,qualityIndex:6,size:3072,videoTitle:"Ultra HD",itag:[38,138]},m[l.QL_VIDEO_FULLHD]={quality:l.QL_HIGH,qualityIndex:5,size:1080,videoTitle:"Full HD",audioTitle:"High",itag:[37,46,137],vimeoQuality:"",zingTag:"f1080",dailymotionQuality:"hd1080",clipvnQuality:"5"},m[l.QL_VIDEO_HD]={quality:l.QL_HIGH,qualityIndex:4,size:720,videoTitle:"HD",audioTitle:"High",itag:[22,45,120,136,247],zingTag:["f720","hq"],vimeoQuality:"hd",dailymotionQuality:["hd","hd720"],facebookQuality:"hd_src",clipvnQuality:"4"},m[l.QL_VIDEO_STANDARD]={quality:l.QL_MEDIUM,qualityIndex:3,size:480,videoTitle:"Standard",audioTitle:"Normal",itag:[44,35,135,244],zingTag:["f480"],dailymotionQuality:"hq",vimeoQuality:"sd",facebookQuality:"sd_src",clipvnQuality:"3"},m[l.QL_VIDEO_MEDIUM]={quality:l.QL_MEDIUM,qualityIndex:2,size:360,videoTitle:"Medium",audioTitle:"Normal",itag:[18,43,34,134,243],vimeoQuality:"",dailymotionQuality:"sd",zingTag:["source","f360"],clipvnQuality:"2"},m[l.QL_VIDEO_SMALL]={quality:l.QL_LOW,qualityIndex:1,size:240,videoTitle:"Small",audioTitle:"Low",itag:[36,5,133,242],dailymotionQuality:"ld",vimeoQuality:"mobile",zingTag:["f","f240"],clipvnQuality:"1"},m[l.QL_VIDEO_MOBILE]={quality:l.QL_LOW,qualityIndex:0,size:144,videoTitle:"Mobile",audioTitle:"Low",itag:[17,6,160],vimeoQuality:"",clipvnQuality:"0"};var n={};n[l.QL_HIGH]=m[l.QL_VIDEO_ULTRAHD].qualityIndex,n[l.QL_MEDIUM]=m[l.QL_VIDEO_STANDARD].qualityIndex,n[l.QL_LOW]=m[l.QL_VIDEO_SMALL].qualityIndex,l.prototype={constructor:l,DEFAULT_QUALITY_LEVEL:l.QL_HIGH,QUALITY_LEVELS:[l.QL_HIGH,l.QL_MEDIUM,l.QL_LOW],VIDEO_QUALITY_LEVELS:[l.QL_VIDEO_FULLHD,l.QL_VIDEO_HD,l.QL_VIDEO_STANDARD,l.QL_VIDEO_MEDIUM,l.QL_VIDEO_SMALL,l.QL_VIDEO_MOBILE],DEFAULT_QUALITY_TYPE:l.QL_VIDEO_STANDARD,QUALITY_TYPES:m,getFacebookQuality:function(a){return this._getVideoQuality("facebookQuality",a).videoTitle},getDailymotionQuality:function(a){return this._getVideoQuality("dailymotionQuality",a).videoTitle},getZingVideoQuality:function(a){return this._getVideoQuality("zingTag",a).videoTitle},getZingAudioQuality:function(a){return this._getVideoQuality("zingTag",a).audioTitle},getYoutubeQuality:function(a,b){var c=this._getVideoQuality("itag",+a,b);return c&&c.videoTitle},getVimeoQuality:function(a){return this._getVideoQuality("vimeoQuality",a).videoTitle},getClipvnQuality:function(a){return this._getVideoQuality("clipvnQuality",a).videoTitle},getQualityBySize:function(a){if(a=parseInt(a),isNaN(a))return null;var b=1/0,c=null,d=this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE];for(var e in this.QUALITY_TYPES){var f=this.QUALITY_TYPES[e];f.size>d.size&&(d=f),a<=1.3*f.size&&f.size<b&&(c=f,b=f.size)}return c=c||d,c.videoTitle},_getVideoQuality:function(a,b,c){for(var d in this.QUALITY_TYPES){var e=this.QUALITY_TYPES[d][a];if(Array.isArray(e)||(e=[e]),-1!==e.indexOf(b))return this.QUALITY_TYPES[d]}return c?null:this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_getTypeByQualityType:function(a){for(var b in this.QUALITY_TYPES)if(a===b||a===this.QUALITY_TYPES[b].videoTitle||a===this.QUALITY_TYPES[b].audioTitle)return this.QUALITY_TYPES[b];return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_calculateWeight:function(a,b){var c=g[a.get("type")].extensions,d=c.indexOf(a.get("ext")),e=this._getTypeByQualityType(a.get("quality")).qualityIndex,f=d/c.length+Math.abs(b-e)/7;return f},getQualityLevelByType:function(a){return Object.keys(this.QUALITY_TYPES).indexOf(this._getTypeByQualityType(a).videoTitle)},getVideoQualityIndex:function(a){return this.VIDEO_QUALITY_LEVELS.concat().reverse().indexOf(a)},getOneClickQualityIndex:function(a){return this.QUALITY_LEVELS.concat().reverse().indexOf(a)},getQualityLevelByQualityType:function(a){return this._getTypeByQualityType(a).quality},chooseBestDownload:function(a,b,c){var d=a.length;if(c)for(var e=0;d>e;++e){var f=a[e];if(f.extQuality()===c)return f}b=b||this.DEFAULT_QUALITY_LEVEL;for(var g=n[b],h=1e3,i=-1,e=0;d>e;++e){var f=a[e],j=this._calculateWeight(f,g);h>j&&(h=j,i=e)}return a[i]}},window.quality=new l;var o=function(a){this._values={},this._sizePromise=null,a.id=a.id||Math.random().toString().substring(2),this.merge(a),this.download=o._downloads[this.id()]||null};o.MAX_FILE_NAME_LENGTH=128,o.isValidData=function(a){return a.type in g&&-1!==g[a.type].extensions.indexOf(a.ext)?!0:!1},o._downloads={},o.prototype._createFieldGetter=function(a){this[a]=function(){return this.get(a)}},o.prototype.get=function(a){return"string"==typeof a||"number"==typeof a?this._values[a]:void 0},o.prototype.set=function(a,b){return"string"!=typeof a&&"number"!=typeof a||this._values[a]===b||(this._values[a]=b,this[a]||this._createFieldGetter(a)),this},o.prototype.merge=function(a){var b=a instanceof o?a._values:a;for(var c in b)this.set(c,"undefined"!=typeof b[c]?b[c]:b[c]||null);return this},o.prototype.title=function(){return(this._values.title||this._values.filename).substr(0,o.MAX_FILE_NAME_LENGTH)},o.prototype.getFilename=function(){var a=this._values.title||this._values.filename,b="."+this._values.ext;return h.endsWith(a,b)||(a+=b),a=a.replace(/\s+/g," ").replace(/[\/\\:*?"<>|\u200c\u200d]/g,"-"),a.substr(0,o.MAX_FILE_NAME_LENGTH)},o.prototype.extQuality=function(){return(this.get("ext")||"")+"/"+(this.get("quality")||"")},o.prototype.size=function(){var a=this.get("size");return a?"("+h.beautifyFileSize(a)+")":""},o.prototype.getSize=function(){if(this._sizePromise)return this._sizePromise;var a=new k;this._sizePromise=a;var b=this,c=this.get("url");"object"==typeof c&&c.videoUrl&&(c=c.videoUrl);var d=this.get("altUrl"),e=this.get("size");return e?(a.resolve(e),a):(h.getSize(c).success(function(c){b.set("size",c),a.resolve(c)}).fail(function(){if(d){var e=h.getSize(d);e.success(function(a){b.set("size",a),cache.put("filesize_"+c,a)}),a.bind(e)}else a.reject(null)}),a)};var p=function(a){this._uninitialized=!0,this.data=[],this.setMediaData(a)};p.prototype={setMediaData:function(b){var c=this,d=new k;return b?(k(b).done(function(b){if(b=b.filter(o.isValidData),c._uninitialized&&0===b.length)return c._uninitialized=!1,void d.reject(c,!0);c._uninitialized=!1;for(var e=c.data,f=[],g=0;g<e.length;g++)f.push(e[g].id());var h=!1,i={};b.forEach(function(b){if(b.id=b.id||a(b),!(b.id in i)){i[b.id]=1;var c=f.indexOf(b.id);-1!==c?(f[c]=null,e[c].merge(b)):(h=!0,e.push(new o(b)))}});for(var g=f.length-1;g>=0;g--)f[g]&&(h=!0,e.splice(g,1));d.resolve(c,h)}),d):(d.reject(this,!1),d)},getMediaCount:function(){var a=this.data;if(0===a.length)return 0;for(var b=0,c={},d=0;d<a.length;++d){var e=a[d],f=e.title()+e.type();c[f]||(c[f]=!0,++b)}return b},getMedia:function(a){return this.data.filter(function(b){return b.id()==a})[0]},getMediaGroup:function(a){return this.data.filter(function(b){return-1!==a.indexOf(b.id())})},download:function(a){var b=this.getMedia(a);if(b){var c={url:b.url(),filename:b.getFilename(),referrer:b.referrer()},d=downloads.download(c);return d.success(function(a){b.download=a,o._downloads[b.id()]=a}),d}},group:function(){return e(b(this.data,["type","title","ext","quality"]))},isOneMedia:function(){for(var a,b,c=this.data,d={},e=0,f=0;e<c.length&&1>=f;++e)if(a=c[e],b=a.title()+a.type(),!d[b]&&(d[b]=!0,++f>1))return!1;return!0}};var q=function(){const a=0,b=10,c=20,d=30;var e=0;if(chrome.extension.getBackgroundPage)switch(document.location.pathname){case"/popup.html":e=a;break;case"/options.html":e=b;break;case"/background.html":e=d;break;default:return}else e=c;var f;return chrome.metricsPrivate?f=function(a,b){chrome.metricsPrivate.recordSmallCount("Savior."+a,b)}:e===c?f=function(a,b){chrome.runtime.sendMessage({requestType:"metrics",method:"log",params:{name:a,value:b}})}:(console.warn("Metrics are not logged"),f=function(a,b){console.info("Metrics",a,b)}),{log:function(a,b){"PageShown"!==a&&(b+=e),"ButtonClicked"===a?a="TryItNowButtonClicked":"CheckBoxClicked"===a&&(a="OneClickCheckbox"),f(a,b)},doLog:e===d?f:null,PAGE_WELCOME_SCREEN:0,PAGE_DOWNLOADS_LIST:1,PAGE_ONE_CLICK_DOWNLOAD:2,PAGE_NO_MEDIA_FOUND:3,PAGE_OPTIONS:4,PAGE_CONTENT_SHOW_CONTROLS:5,PAGE_CONTENT_NO_MEDIA:9,DOWNLOAD_AUTO:0,DOWNLOAD_BUTTON:1,DOWNLOAD_ALL:2,DOWNLOAD_REQUEST_SIZE:3,DOWNLOAD_REQUEST_SIZE_FAILED:4,DOWNLOAD_CANCELED:7,BUTTON_MAIN:0,BUTTON_TRY_IT_NOW:1,BUTTON_SHOW_DOWNLOADS:2,BUTTON_HIDE_DOWNLOADS:3,BUTTON_DOWNLOAD_ALL:4,BUTTON_CHECK_ALL:5,BUTTON_CHECK_NONE:6,BUTTON_FAKE_QUALITY:7,CHECK_BOX_ENABLE_ONE_CLICK:0,CHECK_BOX_SHOW_ON_PAGE_BUTTONS:2}}(),r=function(){var a=new k;return chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT,active:!0},function(b){var c=b&&b[0]&&b[0].id||-1;a.resolve(c)}),a}(),s=function(){this._oneClickDownload=!1,this._init(document.body)};s.prototype={constructor:s,_init:function(a){this._widget=a;var b=this;b._oneClickBlock=h.query("#one-click-block"),this._template=h.query("#list-template").textContent,this._welcome=h.query("#welcome"),a.addEventListener("click",function(a){return b._onClick(a)?void 0:(a.stopPropagation(),!0)},!1),document.addEventListener("change",this._onSelectChange.bind(this),!1),this._oneClickDownload=!!options.get("one_click"),this._drawPopupContent()},_drawPopupContent:function(){var a=!options.get("not_first_run");a&&(f(),this._showWelcomeScreen(),options.set("not_first_run",!0),q.log("PageShown",q.PAGE_WELCOME_SCREEN)),h.query("#downloads").hidden=a,this._welcome.hidden=!a},_showWelcomeScreen:function(){var a=h.query("#welcome-template").textContent,b=Mustache.render(a,{i18n_welcome_title:i("popup_welcome_title"),i18n_welcome_text:i("popup_welcome_text"),i18n_welcome_button:i("popup_welcome_button")});this._welcome.innerHTML=b},_showOneClickDownloadScreen:function(a){var b=h.query("#one-click-template").textContent,c=Mustache.render(b,{media:a,i18n_starting_download:i("popup_starting_download"),i18n_download_failed:i("popup_download_failed")});this._oneClickBlock.innerHTML=c,h.query("#downloads").hidden=!0,this._oneClickBlock.hidden=!1,q.log("PageShown",q.PAGE_ONE_CLICK_DOWNLOAD)},_startDownload:function(a,b,c){var d=this,e=this._downloads.download(a).success(function(){(!c||b)&&setTimeout(function(){window&&window.close()},500)}).fail(function(){d._showDownloadError(b)});return q.log("Download",b?q.DOWNLOAD_AUTO:q.DOWNLOAD_BUTTON),e},_showDownloadError:function(a,b){if(!a){var c=h.query("#error-message");c.classList.add("visible"),this._errorTimeout&&clearTimeout(this._errorTimeout),this._errorTimeout=setTimeout(function(){a||c.classList.remove("visible")},5e3),chrome.extension.getBackgroundPage().console.error('Download has failed. Reason: "%s"',b.message)}},_onClick:function(a){var b=this,c=a.target;switch(c.id){case"close-popup":return void window.close();case"welcome-button":return b._drawPopupContent(),q.log("ButtonClicked",q.BUTTON_TRY_IT_NOW),void setTimeout(function(){document.body.offsetHeight},0)}switch(c.tagName){case"SPAN":var d=c.parentNode;return d.classList.contains("j-quality-download")?void b._download(d):!0;case"INPUT":if(!c.classList.contains("j-one-click"))return!0;var e=!!c.checked;return options.set("one_click",e),void q.log("CheckBoxClicked",q.CHECK_BOX_ENABLE_ONE_CLICK+e)}return!0},_onSelectChange:function(a){var b=a.target;if("SELECT"===b.tagName){if("quality-level-selection"===b.id)options.set("preferred_quality_level",b.value),q.log("OneClickQualityChanged",quality.getOneClickQualityIndex(b.value));else{var c=b.value.split("/")[1],d=h.findParent(b,"j-media-scope");this._applyCurrentValues(d),q.log("VideoQualityChanged",quality.getVideoQualityIndex(c))}return!1}},_checkFileSize:function(a){var b=this._downloads.getMedia(a);b&&!b.get("size")&&(q.log("Download",q.DOWNLOAD_REQUEST_SIZE),b.getSize().done(this._updateFileSize.bind(this,b)))},_updateFileSize:function(a,b){var c=h.query("#size_"+a.id(),this._widget);c&&(c.classList.add("done"),c.textContent=a.size(),b||q.log("Download",q.DOWNLOAD_REQUEST_SIZE_FAILED))},_applyCurrentValues:function(a){var b=a.querySelector(".j-quality-selector"),c=b.value;h.queryAll(".j-quality-option, .j-quality-download",a).forEach(function(a){a.hidden=a.dataset.quality!==c}),this._getSizeOfVisibleMedia()},_getSizeOfVisibleMedia:function(){for(var a=h.query(".downloads-list",this._widget),b=a.scrollTop,c=a.offsetHeight,d=h.queryAll(".j-quality-download:not([hidden])",a),e=0,f=d.length;f>e;++e){var g=d[e];if(g.offsetTop>b+c+10)break;this._checkFileSize(g.dataset.id)}},_render:function(a){var b=this,c=options.get("preferred_quality_level"),d=options.get("preferred_quality:"+c),e={downloads:a.group(),is_single:this._oneClickDownload,is_only:a.isOneMedia(),quality_levels:quality.QUALITY_LEVELS.map(function(a){return{i18n_ql_title:i("ql_"+a.toLowerCase()),name:a,is_checked:a===c}}),i18n_download:i("popup_download").toUpperCase(),i18n_wait:i("popup_download_starting"),i18n_one_click:i("popup_one_click"),i18n_preferred_quality:i("popup_preferred_quality"),i18n_no_media_found:i("popup_no_media_found"),i18n_download_failed:i("popup_download_failed")},f=Mustache.render(this._template,e,{media_template:window.options.get("template-media")}),g=this._widget;h.query("#downloads",g).innerHTML=f,h.queryAll(".j-media-scope",g).forEach(function(e){var f=h.queryAll(".j-quality-download",e);if(f.length>1){var g=f.map(function(a){return a.dataset.id}),i=quality.chooseBestDownload(a.getMediaGroup(g),c,d),j=h.query(".j-quality-selector",e);j&&(j.value=i.extQuality())}b._applyCurrentValues(e)});var j=h.query(".downloads-list",g);j.scrollHeight>j.offsetHeight&&(this._stickyHeaders(h.queryAll("h1",g),j),j.addEventListener("scroll",this._getSizeOfVisibleMedia.bind(this),!1),h.query("#close-popup",g).classList.add("pulled")),g.classList.add("done")},_stickyHeaders:function(a,b){function c(){for(var a=10,c=b.scrollTop,g=-1;e-1>g&&d[g+1].top<=c;)g++;return-1===g?!1:(f!==g&&(-1!==f&&(d[f].node.style.position="static",d[f].placeholder.hidden=!0),d[g].node.style.position="fixed",d[g].placeholder.hidden=!1,f=g),g!==e-1&&c+d[g].height>d[g+1].top?(d[g].node.style.top=a-(c+d[g].height-d[g+1].top)+"px",d[g].node.classList.contains("pulled")||d[g].node.classList.add("pulled")):(d[g].node.style.top=a+"px",d[g].node.classList.contains("pulled")&&d[g].node.classList.remove("pulled")),!1)}var d=[],e=a.length,f=-1;1>e||(b.style.position="relative",d=a.map(function(a){var b=document.createElement("div");return b.style.height=a.offsetHeight+"px",b.hidden=!0,a.parentNode.insertBefore(b,a),{node:a,top:a.offsetTop,height:a.offsetHeight,placeholder:b}}),b.addEventListener("scroll",c,!1))},_download:function(a){a.classList.contains("j-disabled")||(a.classList.add("j-disabled"),a.classList.add("btn-progress"),this._startDownload(a.dataset.id,!1,h.queryAll(".j-media-scope",this._widget).length>1).done(function(){a.classList.remove("btn-progress")}).success(function(){a.classList.add("btn-started"),a.classList.remove("j-disabled")}))},setDownloads:function(a){var b=this;b._downloads=a;var c=a.getMediaCount();if(b._oneClickDownload&&1===c){var d=options.get("preferred_quality_level"),e=options.get("preferred_quality:"+d),f=quality.chooseBestDownload(a.data,d,e);b._showOneClickDownloadScreen(f),b._startDownload(f.id(),!0,!1).fail(function(a){b._render(b._downloads),h.query("#downloads").hidden=!1,b._oneClickBlock.hidden=!0,b._showDownloadError(!1,a)})}else b._render(b._downloads),q.log("PageShown",0===c?q.PAGE_NO_MEDIA_FOUND:q.PAGE_DOWNLOADS_LIST)}},window.onload=function(){var a=chrome.extension.getBackgroundPage();window.options=a.options,window.cache=a.cache;var b=new s;r.done(function(c){a.db.getMediaForTab(c).done(function(a){b.setDownloads(a)})})}}();