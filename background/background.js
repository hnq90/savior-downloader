!function(){function a(a){var b=a.url,a="object"==typeof b?b.videoUrl+"\n"+b.audioUrl:b,c=m.hash(a);return c.toString()}function b(a,c){var d=c[0],e={};if(!d){if(a.length>1)for(var f=0;f<a.length;++f){var g=a[f],h=g.url();if("object"==typeof h&&(h=h.videoUrl),-1!==h.indexOf(".googlevideo.com"))return[g]}return[a[0]]}return a.forEach(function(a){var b=a[d]&&a[d]()||"";e[b]=e[b]||[],e[b].push(a)}),Object.keys(e).map(function(a){var f=b(e[a],c.slice(1)),g={media:f};return g[d]=m.defined(a)?a:void 0,g.is_only=1===f.length&&(!m.defined(f[0].is_only)||f[0].is_only),g["i18n_"+d]=n("media_fields_"+d+"_"+a),g})}function c(a){return a.forEach(function(a){var b=a.type;a.media.forEach(function(a){a.media=a.media.sort(function(a,c){return j[b].extensions.indexOf(a.ext)-j[b].extensions.indexOf(c.ext)})})}),a}function d(a){return a.ext?(a.media=a.media.sort(function(a,b){return quality.getQualityLevelByType(a.quality)-quality.getQualityLevelByType(b.quality)}),a):(Array.isArray(a)?a=a.map(d):a.media=d(a.media),a)}function e(a){return d(c(a))}function f(){var a=this;a._download2tab={},a._downloadItems={},chrome.downloads.onCreated.addListener(function(b){a._downloadItems[b.id]=b,console.log("download item",b)}),chrome.downloads.onErased.addListener(function(b){var c=a._download2tab[b];c&&a._sendMessage(c,"erased",b),delete a._download2tab[b],delete a._downloadItems[b]}),chrome.downloads.onChanged.addListener(function(b){var c=a._download2tab[b.id];c&&a._sendMessage(c,"changed",b),a._downloadItems[b.id]&&b.error&&"USER_CANCELED"===b.error.current&&x.log("Download",x.DOWNLOAD_CANCELED)})}function g(a,b,c){return{name:a,hosts:Array.isArray(b)?b:[b],match:c}}function h(a,b,c){chrome.tabs.sendMessage(a,{requestType:"request.matched",name:b,result:c})}function i(a,b){if("flv"!==a.ext)return!1;var c=b.server;return c&&-1!==c.indexOf("icecast")}const j={audio:{title:"Audio",contentTypes:[/audio/i],extensions:["mp3","flac","m4a","wma","ogg","wav","aif","mid"],ctype2extension:{midi:"mid",mp4:"m4a",m4a:"m4a",mpeg:"mp3",mpeg3:"mp3",wav:"wav",aiff:"aif"}},video:{title:"Video",contentTypes:[/video/i],extensions:["mp4","mpeg4","mpg","mpeg","m4v","avi","divx","mov","wmv","movie","asf","webm","flv","3gp"],ctype2extension:{mpeg:"mp4",mp4:"mp4",m4v:"mp4","3gpp":"3gp",flv:"flv",quicktime:"mov",msvideo:"avi","ms-wmv":"wmv","ms-asf":"asf"}}},k=(function(){var a={};return Object.keys(j).forEach(function(b){for(var c=j[b].extensions,d=0;d<c.length;d++)a[c[d]]=b}),a}(),[/^(.+\.)?youtube.com/i,/^(.+\.)?zing.vn/i,/^(.+\.)?nhaccuatui.com/i,/^(.+\.)?nhacso.net/i,/^(.+\.)?vimeo.com/i,/^(.+\.)?clip.vn/i,/vietgiaitri\.com/i]),l=[/^(.+\.)?nixcdn.com/im];var m={EXTENSION_RE:/\.([^/.]*)$/i,FILENAME_RE:/([^/]+)$/i,SIZES:["","K","M","G","T","P"],xmlParser:new DOMParser,urlParser:document.createElement("a"),fileDownloader:document.createElement("a"),strip:function(a){return a.replace(/(^\s+)|(\s+$)/m,"")},endsWith:function(a,b){var c=a.length-b.length;return a.indexOf(b,c)===c},hash:function(a,b){if(b=0|b,0===a.length)return b;var c,d;for(c=0,d=a.length;d>c;c++)b=(b<<5)-b+a.charCodeAt(c),b|=0;return b},query:function(a,b){return b=b||document,b.querySelector(a)},queryAll:function(a,b){return b=b||document,m.toArray(b.querySelectorAll(a))},findParent:function(a,b){for(;null!==a&&!a.classList.contains(b);)a=a.parentNode;return a},toArray:function(a){return Array.prototype.slice.call(a)},unique:function(a){var b=[];return Array.isArray(a)?(a.forEach(function(a){-1===b.indexOf(a)&&b.push(a)}),b):a},extend:function(a,b){var c=function(){};c.prototype=a.prototype,b.prototype=new c,b.prototype.constructor=b,b._super=a.prototype},parseUrl:function(a){var b=m.urlParser;b.setAttribute("href",a);var c=(b.pathname.match(m.FILENAME_RE)||[])[1]||"",d=c.split(".").map(function(a){return a.toLowerCase()});c=decodeURIComponent(c.replace(m.EXTENSION_RE,"")),d.shift();var e=d[d.length-1]||"";return{url:a,protocol:b.protocol,host:b.host,port:b.port,pathname:b.pathname,filename:c,ext:e,exts:d,search:b.search}},isMatches:function(a,b){var c,d,e;if(Array.isArray(a)){for(c=0;c<a.length;++c)if(m.isMatches(a[c],b))return!0;return!1}for(b=Array.isArray(b)?b:[b],c=0,d=b.length,e;d>c;++c)if(e=b[c],"string"==typeof e&&-1!==a.indexOf(e)||e instanceof RegExp&&a.match(e))return!0;return!1},_sendBackgroundRequest:function(a,b,c,d){var e=new p;return chrome.runtime.sendMessage({requestType:"make_http_request",method:a,url:b,params:c,headers:d},function(a){e[a.success?"resolve":"reject"](a.data)}),e},send:function(a,b,c,d){var e=new p,f=null;if(m.IS_CONTENT_SCRIPT)return m._sendBackgroundRequest(a,b,c,d);try{var g=new XMLHttpRequest;if(g.open(a,b,!0),g.setRequestHeader("Cache-Control","no-cache"),"object"==typeof c&&(f=Object.keys(c).map(function(a){return a+"="+c[a]}).join("&")),"object"==typeof d)for(var h in d)g.setRequestHeader(h,d[h]);"POST"===a&&g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g.onload=function(){e.resolve(this.responseText)},g.onerror=function(){e.reject()},g.send(f)}catch(i){e.reject()}return e},get:function(a,b){return m.send("GET",a,{},b)},post:function(a,b,c){return m.send("POST",a,b,c)},_getSize:function(a){function b(a){d&&d[a?"resolve":"reject"](a),d=null,c.abort(),clearTimeout(e),e=null}var c=new XMLHttpRequest,d=new p,e=null,f=1e4;return c.open("GET",a),c.setRequestHeader("Cache-Control","no-cache"),c.url=a,c.onreadystatechange=function(){if(!(this.readyState<2)){var a=null;try{a=+this.getResponseHeader("Content-Length")}catch(c){}(null!==a||200===this.status)&&(200!==this.status&&(a=null),b(a))}},c.send(null),e=setTimeout(b,f),d},getSize:function(a){var b=new p,c=window.cache;return c.get(a).success(function(d){d?(b.resolve(d),c.put(a,d)):b.bind(m._getSize(a)).success(c.put.bind(c,a))}).fail(function(){b.bind(m._getSize(a)).success(c.put.bind(c,a))}),b},beautifyFileSize:function(a){if(null===a||"undefined"==typeof a)return"???";for(var b=0;b<m.SIZES.length&&a>=1024;++b,a/=1024);return Math.round(10*a)/10+m.SIZES[b]+"b"},detectMediaTypeAndExt:function(a,b){b=b||"","string"==typeof a&&(a=m.parseUrl(a));var c=m.getMediaType(b,a.exts);return c&&j[c]&&(a.type=c,a.ext=this._findIntersection(a.exts,j[c].extensions)||m.extByContentType(b,c)||a.ext),a},getMediaType:function(a,b){var c;for(var d in j){c=j[d];for(var e=0;e<c.contentTypes.length;++e)if(a.match(c.contentTypes[e]))return d;if(Array.isArray(b)&&m._findIntersection(b,c.extensions)||-1!==c.extensions.indexOf(b))return d}return null},_findIntersection:function(a,b){for(var c=a.concat(b),d={},e=0;e<c.length;++e){var f=c[e];if(d[f])return f;d[f]=!0}return null},extByContentType:function(a,b){var c=j[b].ctype2extension;for(var d in c)if(-1!==a.indexOf(d))return c[d];return null},isTrue:function(a){return!!a},noop:function(){},defined:function(a){return"undefined"!=typeof a},notNull:function(a){return null!==a}},n=chrome.i18n.getMessage;try{chrome.extension.getBackgroundPage(),m.IS_CONTENT_SCRIPT=!1}catch(o){m.IS_CONTENT_SCRIPT=!0}var p=function(a){if(0===arguments.length)return this._init(),this;if(a instanceof p)return a;var b=new p;return b.resolve(a),b};p.RUNNING=0,p.RESOLVED=1,p.FAILED=2,p.prototype={constructor:p,_init:function(){this._results=[],this._subscribers=[],this.state=p.RUNNING},_notify:function(){var a=this;this._subscribers.forEach(function(b){b.apply(a,a._results)}),this._subscribers=[]},resolve:function(){return this.state=p.RESOLVED,this._results=arguments,this._notify(),this},reject:function(){return this.state=p.FAILED,this._results=arguments,this._notify(),this},subscribe:function(a){this.state!==p.RUNNING?a.apply(this,this._results):this._subscribers.push(a)},done:function(a){return this.subscribe(a),this},success:function(a){var b=this;return this.subscribe(function(){b.state===p.RESOLVED&&a.apply(b,b._results)}),this},fail:function(a){var b=this;return this.subscribe(function(){b.state===p.FAILED&&a.apply(b,b._results)}),this},bind:function(a){return a=new p(a),a.success(this.resolve.bind(this)).fail(this.reject.bind(this)),this}},p.when=function(){var a=[];return a=Array.isArray(arguments[0])?arguments[0]:m.toArray(arguments),new p.When(a)},p.When=function(a){this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[],this._state=p.RUNNING,this._thingsToDo=a.length,this._results=Array(this._thingsToDo),this._init(a)},p.When.prototype={constructor:p.When,_init:function(a){var b=this;a.forEach(function(a,c){a=new p(a),a.subscribe(function(){a.state===p.FAILED&&(b._state=p.FAILED),b._results[c]=m.toArray(arguments),b._thingsToDo--,b._checkIsDone()})}),this._checkIsDone()},_checkIsDone:function(){if(0!==this._thingsToDo)return!1;var a=[];this._results.forEach(function(b){a=a.concat(b)}),this._state===p.FAILED?this._runCallbacks(this._failCallbacks,a):this._runCallbacks(this._successCallbacks,a),this._runCallbacks(this._doneCallbacks,a),this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[]},_runCallbacks:function(a,b){a.forEach(function(a){a.apply(this,b)})},done:function(a){return this._doneCallbacks.push(a),this._checkIsDone(),this},success:function(a){return this._successCallbacks.push(a),this._checkIsDone(),this},fail:function(a){return this._failCallbacks.push(a),this._checkIsDone(),this}},p.chain=function(){function a(b){if(!b.length)return c.resolve.apply(c,d);var e,f=b.shift();"function"==typeof f?(e=p(f()),e.done(function(c){d.push(c),a(b)})):(d.push(f),a(b))}var b,c=new p,d=[];return b=Array.isArray(arguments[0])?arguments[0]:m.toArray(arguments),a(b),c};var q=function(){this._storage=chrome.storage.local,this._options={},this._default={on_page_buttons:!0};var a=this;chrome.storage.onChanged.addListener(function(b,c){if("local"===c)for(var d in b)a._options[d]=b[d].newValue})};q.prototype={load:function(){var a=new p,b=this;return this._storage.get(null,function(c){b._options=c,a.resolve(c)}),a},set:function(a,b){var c={};("string"==typeof a||"number"==typeof a&&"undefined"!=typeof b)&&(c[a]=b,this._options[a]=b,this._storage.set(c))},get:function(a){return a in this._options?this._options[a]:this._default[a]}};var r=function(){};r.QL_HIGH="High",r.QL_MEDIUM="Medium",r.QL_LOW="Low",r.QL_VIDEO_ULTRAHD="Ultra HD",r.QL_VIDEO_FULLHD="Full HD",r.QL_VIDEO_HD="HD",r.QL_VIDEO_STANDARD="Standard",r.QL_VIDEO_MEDIUM="Medium",r.QL_VIDEO_SMALL="Small",r.QL_VIDEO_MOBILE="Mobile";var s={};s[r.QL_VIDEO_ULTRAHD]={quality:r.QL_HIGH,qualityIndex:6,size:3072,videoTitle:"Ultra HD",itag:[38,138]},s[r.QL_VIDEO_FULLHD]={quality:r.QL_HIGH,qualityIndex:5,size:1080,videoTitle:"Full HD",audioTitle:"High",itag:[37,46,137],vimeoQuality:"",zingTag:"f1080",dailymotionQuality:"hd1080",clipvnQuality:"5"},s[r.QL_VIDEO_HD]={quality:r.QL_HIGH,qualityIndex:4,size:720,videoTitle:"HD",audioTitle:"High",itag:[22,45,120,136,247],zingTag:["f720","hq"],vimeoQuality:"hd",dailymotionQuality:["hd","hd720"],facebookQuality:"hd_src",clipvnQuality:"4"},s[r.QL_VIDEO_STANDARD]={quality:r.QL_MEDIUM,qualityIndex:3,size:480,videoTitle:"Standard",audioTitle:"Normal",itag:[44,35,135,244],zingTag:["f480"],dailymotionQuality:"hq",vimeoQuality:"sd",facebookQuality:"sd_src",clipvnQuality:"3"},s[r.QL_VIDEO_MEDIUM]={quality:r.QL_MEDIUM,qualityIndex:2,size:360,videoTitle:"Medium",audioTitle:"Normal",itag:[18,43,34,134,243],vimeoQuality:"",dailymotionQuality:"sd",zingTag:["source","f360"],clipvnQuality:"2"},s[r.QL_VIDEO_SMALL]={quality:r.QL_LOW,qualityIndex:1,size:240,videoTitle:"Small",audioTitle:"Low",itag:[36,5,133,242],dailymotionQuality:"ld",vimeoQuality:"mobile",zingTag:["f","f240"],clipvnQuality:"1"},s[r.QL_VIDEO_MOBILE]={quality:r.QL_LOW,qualityIndex:0,size:144,videoTitle:"Mobile",audioTitle:"Low",itag:[17,6,160],vimeoQuality:"",clipvnQuality:"0"};var t={};t[r.QL_HIGH]=s[r.QL_VIDEO_ULTRAHD].qualityIndex,t[r.QL_MEDIUM]=s[r.QL_VIDEO_STANDARD].qualityIndex,t[r.QL_LOW]=s[r.QL_VIDEO_SMALL].qualityIndex,r.prototype={constructor:r,DEFAULT_QUALITY_LEVEL:r.QL_HIGH,QUALITY_LEVELS:[r.QL_HIGH,r.QL_MEDIUM,r.QL_LOW],VIDEO_QUALITY_LEVELS:[r.QL_VIDEO_FULLHD,r.QL_VIDEO_HD,r.QL_VIDEO_STANDARD,r.QL_VIDEO_MEDIUM,r.QL_VIDEO_SMALL,r.QL_VIDEO_MOBILE],DEFAULT_QUALITY_TYPE:r.QL_VIDEO_STANDARD,QUALITY_TYPES:s,getFacebookQuality:function(a){return this._getVideoQuality("facebookQuality",a).videoTitle},getDailymotionQuality:function(a){return this._getVideoQuality("dailymotionQuality",a).videoTitle},getZingVideoQuality:function(a){return this._getVideoQuality("zingTag",a).videoTitle},getZingAudioQuality:function(a){return this._getVideoQuality("zingTag",a).audioTitle},getYoutubeQuality:function(a,b){var c=this._getVideoQuality("itag",+a,b);return c&&c.videoTitle},getVimeoQuality:function(a){return this._getVideoQuality("vimeoQuality",a).videoTitle},getClipvnQuality:function(a){return this._getVideoQuality("clipvnQuality",a).videoTitle},getQualityBySize:function(a){if(a=parseInt(a),isNaN(a))return null;var b=1/0,c=null,d=this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE];for(var e in this.QUALITY_TYPES){var f=this.QUALITY_TYPES[e];f.size>d.size&&(d=f),a<=1.3*f.size&&f.size<b&&(c=f,b=f.size)}return c=c||d,c.videoTitle},_getVideoQuality:function(a,b,c){for(var d in this.QUALITY_TYPES){var e=this.QUALITY_TYPES[d][a];if(Array.isArray(e)||(e=[e]),-1!==e.indexOf(b))return this.QUALITY_TYPES[d]}return c?null:this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_getTypeByQualityType:function(a){for(var b in this.QUALITY_TYPES)if(a===b||a===this.QUALITY_TYPES[b].videoTitle||a===this.QUALITY_TYPES[b].audioTitle)return this.QUALITY_TYPES[b];return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_calculateWeight:function(a,b){var c=j[a.get("type")].extensions,d=c.indexOf(a.get("ext")),e=this._getTypeByQualityType(a.get("quality")).qualityIndex,f=d/c.length+Math.abs(b-e)/7;return f},getQualityLevelByType:function(a){return Object.keys(this.QUALITY_TYPES).indexOf(this._getTypeByQualityType(a).videoTitle)},getVideoQualityIndex:function(a){return this.VIDEO_QUALITY_LEVELS.concat().reverse().indexOf(a)},getOneClickQualityIndex:function(a){return this.QUALITY_LEVELS.concat().reverse().indexOf(a)},getQualityLevelByQualityType:function(a){return this._getTypeByQualityType(a).quality},chooseBestDownload:function(a,b,c){var d=a.length;if(c)for(var e=0;d>e;++e){var f=a[e];if(f.extQuality()===c)return f}b=b||this.DEFAULT_QUALITY_LEVEL;for(var g=t[b],h=1e3,i=-1,e=0;d>e;++e){var f=a[e],j=this._calculateWeight(f,g);h>j&&(h=j,i=e)}return a[i]}},window.quality=new r;var u=function(){this._cache={}};u.prototype={constructor:u,processRequest:function(a,b,c){var d=this;switch(b){case"get":return d.get(c.key);case"put":d.put(c.key,c.value,c.ttl);break;case"delete":d["delete"](c.key)}},DEFAULT_TTL:12e5,get:function(a){var b=new p;return a in this._cache?b.resolve(this._cache[a]):b.reject(null),b},put:function(a,b,c){a&&"undefined"!=typeof b&&(c=c||this.DEFAULT_TTL,this._cache[a]=b,setTimeout(this["delete"].bind(this,a),c))},"delete":function(a){this._cache[a]&&delete this._cache[a]}};var v=function(a){this._values={},this._sizePromise=null,a.id=a.id||Math.random().toString().substring(2),this.merge(a),this.download=v._downloads[this.id()]||null};v.MAX_FILE_NAME_LENGTH=128,v.isValidData=function(a){return a.type in j&&-1!==j[a.type].extensions.indexOf(a.ext)?!0:!1},v._downloads={},v.prototype._createFieldGetter=function(a){this[a]=function(){return this.get(a)}},v.prototype.get=function(a){return"string"==typeof a||"number"==typeof a?this._values[a]:void 0},v.prototype.set=function(a,b){return"string"!=typeof a&&"number"!=typeof a||this._values[a]===b||(this._values[a]=b,this[a]||this._createFieldGetter(a)),this},v.prototype.merge=function(a){var b=a instanceof v?a._values:a;for(var c in b)this.set(c,"undefined"!=typeof b[c]?b[c]:b[c]||null);return this},v.prototype.title=function(){return(this._values.title||this._values.filename).substr(0,v.MAX_FILE_NAME_LENGTH)},v.prototype.getFilename=function(){var a=this._values.title||this._values.filename,b="."+this._values.ext;return m.endsWith(a,b)||(a+=b),a=a.replace(/\s+/g," ").replace(/[\/\\:*?"<>|\u200c\u200d]/g,"-"),a.substr(0,v.MAX_FILE_NAME_LENGTH)},v.prototype.extQuality=function(){return(this.get("ext")||"")+"/"+(this.get("quality")||"")},v.prototype.size=function(){var a=this.get("size");return a?"("+m.beautifyFileSize(a)+")":""},v.prototype.getSize=function(){if(this._sizePromise)return this._sizePromise;var a=new p;this._sizePromise=a;var b=this,c=this.get("url");"object"==typeof c&&c.videoUrl&&(c=c.videoUrl);var d=this.get("altUrl"),e=this.get("size");return e?(a.resolve(e),a):(m.getSize(c).success(function(c){b.set("size",c),a.resolve(c)}).fail(function(){if(d){var e=m.getSize(d);e.success(function(a){b.set("size",a),cache.put("filesize_"+c,a)}),a.bind(e)}else a.reject(null)}),a)};var w=function(a){this._uninitialized=!0,this.data=[],this.setMediaData(a)};w.prototype={setMediaData:function(b){var c=this,d=new p;return b?(p(b).done(function(b){if(b=b.filter(v.isValidData),c._uninitialized&&0===b.length)return c._uninitialized=!1,void d.reject(c,!0);c._uninitialized=!1;for(var e=c.data,f=[],g=0;g<e.length;g++)f.push(e[g].id());var h=!1,i={};b.forEach(function(b){if(b.id=b.id||a(b),!(b.id in i)){i[b.id]=1;var c=f.indexOf(b.id);-1!==c?(f[c]=null,e[c].merge(b)):(h=!0,e.push(new v(b)))}});for(var g=f.length-1;g>=0;g--)f[g]&&(h=!0,e.splice(g,1));d.resolve(c,h)}),d):(d.reject(this,!1),d)},getMediaCount:function(){var a=this.data;if(0===a.length)return 0;for(var b=0,c={},d=0;d<a.length;++d){var e=a[d],f=e.title()+e.type();c[f]||(c[f]=!0,++b)}return b},getMedia:function(a){return this.data.filter(function(b){return b.id()==a})[0]},getMediaGroup:function(a){return this.data.filter(function(b){return-1!==a.indexOf(b.id())})},download:function(a){var b=this.getMedia(a);if(b){var c={url:b.url(),filename:b.getFilename(),referrer:b.referrer()},d=z.download(c);return d.success(function(a){b.download=a,v._downloads[b.id()]=a}),d}},group:function(){return e(b(this.data,["type","title","ext","quality"]))},isOneMedia:function(){for(var a,b,c=this.data,d={},e=0,f=0;e<c.length&&1>=f;++e)if(a=c[e],b=a.title()+a.type(),!d[b]&&(d[b]=!0,++f>1))return!1;return!0}};var x=function(){const a=0,b=10,c=20,d=30;var e=0;if(chrome.extension.getBackgroundPage)switch(document.location.pathname){case"/popup.html":e=a;break;case"/options.html":e=b;break;case"/background.html":e=d;break;default:return}else e=c;var f;return chrome.metricsPrivate?f=function(a,b){chrome.metricsPrivate.recordSmallCount("Savior."+a,b)}:e===c?f=function(a,b){chrome.runtime.sendMessage({requestType:"metrics",method:"log",params:{name:a,value:b}})}:(console.warn("Metrics are not logged"),f=function(a,b){console.info("Metrics",a,b)}),{log:function(a,b){"PageShown"!==a&&(b+=e),"ButtonClicked"===a?a="TryItNowButtonClicked":"CheckBoxClicked"===a&&(a="OneClickCheckbox"),f(a,b)},doLog:e===d?f:null,PAGE_WELCOME_SCREEN:0,PAGE_DOWNLOADS_LIST:1,PAGE_ONE_CLICK_DOWNLOAD:2,PAGE_NO_MEDIA_FOUND:3,PAGE_OPTIONS:4,PAGE_CONTENT_SHOW_CONTROLS:5,PAGE_CONTENT_NO_MEDIA:9,DOWNLOAD_AUTO:0,DOWNLOAD_BUTTON:1,DOWNLOAD_ALL:2,DOWNLOAD_REQUEST_SIZE:3,DOWNLOAD_REQUEST_SIZE_FAILED:4,DOWNLOAD_CANCELED:7,BUTTON_MAIN:0,BUTTON_TRY_IT_NOW:1,BUTTON_SHOW_DOWNLOADS:2,BUTTON_HIDE_DOWNLOADS:3,BUTTON_DOWNLOAD_ALL:4,BUTTON_CHECK_ALL:5,BUTTON_CHECK_NONE:6,BUTTON_FAKE_QUALITY:7,CHECK_BOX_ENABLE_ONE_CLICK:0,CHECK_BOX_SHOW_ON_PAGE_BUTTONS:2}}(),y=function(){var a=this;this._media={},chrome.tabs.onRemoved.addListener(function(b){a.resetAllMedia(b,!0)})};y.prototype={constructor:y,processRequest:function(a,b,c){var d=this;switch(b){case"reset_all":d.resetAllMedia(a);break;case"set_present":d.setHasMedia(a,c)}},showPageActionState:function(a){var b=!!this._media[a];chrome.pageAction[b?"show":"hide"](a),chrome.runtime.lastError&&console.warn(chrome.runtime.lastError),b&&!options.get("not_first_run")&&chrome.pageAction.showPopup&&setTimeout(function(){chrome.tabs.query({active:!0,windowType:"normal"},function(b){b.length&&b[0].id==a&&(options.get("not_first_run")||chrome.pageAction.showPopup())})},5e3)},_requestMediaFromCS:function(a){var b=new p;return chrome.tabs.sendMessage(a,{requestType:"get_media"},function(a){b.resolve(a)}),b},resetAllMedia:function(a,b){delete this._media[a],b||this.showPageActionState(a)},setHasMedia:function(a,b){this._media[a]=b,this.showPageActionState(a)},getMediaForTab:function(a){var b=new p;return this._requestMediaFromCS(a).done(function(a){b.resolve(new w(a))}),b}},window.db=new y,f.prototype={processRequest:function(a,b,c){var d=this;switch(b){case"download":var e=this.download(c);return e.success(function(b){d._download2tab[b.id]=a}),e;case"pause":d.pause(c);break;case"resume":d.resume(c);break;case"cancel":d.cancel(c);break;case"open":d.open(c);break;case"show":d.show(c)}},_sendMessage:function(a,b,c,d){chrome.tabs.sendMessage(a,{requestType:"downloads",method:b,params:c},d)},download:function(a){function b(a){if(a){var b=c._downloadItems[a];if(b)return void d.resolve(b);console.log("O_o no download data:",a)}d.reject(chrome.runtime.lastError)}var c=this,d=new p,e=a.url,f=a.referrer,g={filename:a.filename};if(chrome.mediaDownload){f&&(g.referrer=f);var h="string"==typeof e?e:[e.audioUrl,e.videoUrl].filter(m.defined);m.isMatches(h,l)&&(g.streamsNumber=1)}return"object"==typeof e?e.videoUrl&&e.audioUrl?chrome.mediaDownload?(g.videoUrl=e.videoUrl,g.audioUrl=e.audioUrl):g.url=e.videoUrl:b():g.url=e,"string"==typeof g.url?(g.conflictAction="uniquify",chrome.downloads.download(g,b)):chrome.mediaDownload.combineStreams(g,b),d},pause:function(a){chrome.downloads.pause(a)},resume:function(a){chrome.downloads.resume(a)},cancel:function(a){chrome.downloads.cancel(a)},open:function(a){chrome.downloads.open(a)},show:function(a){chrome.downloads.show(a)}};var z=new f,A=function(){};A.prototype={constructor:A,name:"default",EXCLUDE_URLS:["youtube.com","vimeo.com",/^(.+\.)?vimeocdn.com/,"fbcdn.net",/^(.+\.)?clip.vn$/i,"subs.xemphimonlines.com","dailymotion.com","dmcdn.net",/.*dailymotion.*\/frag\(\d+\)\//gi,"nhacrap.tv","nixcdn.com",/^(.+\.)?zdn.vn$/i,"vui.vn",/^(.+\.)?24hstatic.com$/i,"adnetwork.vn","doubleclick.net","admicro","adnet.vn","ds-vn.serving-sys.com","lavanetwork.net"],match:function(a,b,c){var d,e;if(!m.isMatches(b.host,this.EXCLUDE_URLS)&&c["content-type"]){var d=m.detectMediaTypeAndExt(b,c["content-type"]);if(d.type&&b.ext){if(!v.isValidData(d)||i(d,c))return;if(d.url=this._filterUrl(a.url),302!==a.statusCode&&c["content-length"]&&(d.size=c["content-length"],e=options.get("min_stream_size"),d.size<e))return;302===a.statusCode&&a.redirectUrl&&(d.altUrl=this._filterUrl(a.redirectUrl)),this._reportNewMedia(a,d)}}},_reportNewMedia:function(a,b){function c(a){var c=m.parseUrl(a);m.isMatches(c.host,k)||!c.protocol.match(/^http|^ftp/)||"coccoc.com"===c.host&&"/webhp"===c.pathname||d._extractVideoTitle(e,b).done(function(c){b.title=c,b.referrer=a,h(e,d.name,b)})}var d=this,e=a.tabId;-1===a.parentFrameId?chrome.tabs.get(e,function(a){c(a.url)}):chrome.webNavigation.getAllFrames({tabId:e},function(b){var d=b.filter(function(b){return b.frameId===a.frameId})[0];d&&c(d.url)})},_extractVideoTitle:function(a,b){var c=new p;return chrome.tabs.sendMessage(a,{requestType:"extract_file_name",media:b},function(a){c.resolve(a)}),c},_filterUrl:function(a){var b=a;return a.match(/googlevideo\.com/g)&&(b=b.replace(/[&?]begin=\d+/g,"")),b}};var B=function(a){this._listeners=a,this._init()};B.prototype={constructor:B,_init:function(){var a=this._onResponseStarted.bind(this),b={urls:["*://*/*"],types:["xmlhttprequest","object","other"]};chrome.webRequest.onBeforeRedirect.addListener(a,b,["responseHeaders"]),chrome.webRequest.onResponseStarted.addListener(a,b,["responseHeaders"])},_onResponseStarted:function(a){if(!(a.tabId<0)){var b=this._parseHeaders(a.responseHeaders),c=m.parseUrl(a.url);this._listeners.some(function(d){if(!d.hosts||m.isMatches(c.host,d.hosts)){var e=d.match(a,c,b);return e&&h(a.tabId,d.name,e),!0}})}},_parseHeaders:function(a){var b={};return a.length?(a.forEach(function(a){b[a.name.toLowerCase()]=a.value.toLowerCase()}),b):{}}},new B([g("youtube","youtube.com",function(a,b){var c;return b.pathname.match(/^\/(api|get)_video_info/)&&(c=b.search.match(/(?:&|\?)video_id=([^&]+)(?:&|$)/i))?c[1]:void 0}),g("zingvn",/[a-z0-9]+\.zing\.vn/i,function(a,b){var c=b.pathname;return c.match(/\/([a-z-]+\/)?xml\//gi)&&-1===c.indexOf("load-song")?b.protocol+"//"+b.host+b.pathname:void 0}),g("nhaccuatui","www.nhaccuatui.com",function(a,b){return b.search.match(/^\?key[0-9]=[0-9a-f]{32}/i)?a.url:void 0}),g("dailymotion",/(www\.)?dailymotion\.com$/,function(a,b){var c=b.pathname.match(/^\/sequence\/(play|full)\/([a-z0-9]+)/i);return c?c[2]:void 0}),g("vimeo",/player\.vimeo\.com$/i,function(a,b){var c=(b.pathname+b.search).match(/\/video\/(\d+)\/config(\?|$)/i);return c?a.url:void 0}),new A]);console.log("BG:run"),window.onRequest=function(a,b,c){var d=null;switch(a.requestType){case"media":d=db.processRequest(b.tab.id,a.method,a.params);break;case"cache":d=cache.processRequest(b.tab.id,a.method,a.params);break;case"make_http_request":d=m.send(a.method,a.url,a.params,a.headers);break;case"downloads":d=z.processRequest(b.tab.id,a.method,a.params);break;case"metrics":if("log"===a.method){var e=a.params;x.doLog(e.name,e.value)}}return d?(d.done(function(a){c({success:d.state===p.RESOLVED,data:a})}),!0):void 0},window.db=new y,window.options=new q,window.cache=new u;var C=options.load();C.done(function(){options.get("preferred_quality_level")||options.set("preferred_quality_level",quality.DEFAULT_QUALITY_LEVEL),chrome.runtime.onMessage.addListener(onRequest),chrome.tabs.onUpdated.addListener(function(a,b,c){c.url.match(/^chrome:/)&&db.resetAllMedia(a),"complete"===b.status&&db.showPageActionState(a)})}),document.addEventListener("DOMContentLoaded",function(){console.log("BG:DOMContentLoaded"),C.done(function(){options.set("template-widget",m.query("#template-widget").textContent),options.set("template-list",m.query("#template-list").textContent),options.set("template-media",m.query("#template-media").textContent)})})}();